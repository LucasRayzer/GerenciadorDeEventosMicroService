name: SonarQube Multi-Environment

on:
  push:
    branches:
      - main
      - develop
      - homolog
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Set environment based on branch
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/homolog" ]]; then
            echo "environment=homologation" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

  build-and-analyze:
    name: Build and Analyze - ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ needs.determine-environment.outputs.environment }}
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}
        run: |
          echo "Analyzing branch ${{ github.ref_name }} for environment: $ENVIRONMENT"
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=LucasRayzer_GerenciadorDeEventosMicroService \
            -Dsonar.organization=lucasrayzer \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.branch.name=${{ github.ref_name }}

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-analyze]
    if: needs.determine-environment.outputs.environment == 'development'
    environment: 
      name: development
      url: https://dev.seudominio.com
    steps:
      - name: Deploy to Development
        run: |
          echo "Deploying to Development environment..."
          echo "Branch: ${{ github.ref_name }}"
          # Adicione seus comandos de deploy aqui

  deploy-homologation:
    name: Deploy to Homologation
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-analyze]
    if: needs.determine-environment.outputs.environment == 'homologation'
    environment: 
      name: homologation
      url: https://homolog.seudominio.com
    steps:
      - name: Deploy to Homologation
        run: |
          echo "Deploying to Homologation environment..."
          echo "Branch: ${{ github.ref_name }}"
          # Adicione seus comandos de deploy aqui

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-analyze]
    if: needs.determine-environment.outputs.environment == 'production'
    environment: 
      name: production
      url: https://prod.seudominio.com
    steps:
      - name: Deploy to Production
        run: |
          echo "Deploying to Production environment..."
          echo "Branch: ${{ github.ref_name }}"
          # Adicione seus comandos de deploy aqui
